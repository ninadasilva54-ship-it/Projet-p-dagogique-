<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commande de kits de survie</title>
<link rel="stylesheet" href="style.css">
<style>
    /* --- AJOUTS CSS --- */
    
    /* Styles des cartes de cours */
    .course-card h3 {
        white-space: normal;
        overflow: visible;
        word-wrap: break-word;
        min-height: 60px;
        margin-bottom: 15px;
        font-size: 1.1em;
        line-height: 1.4;
    }

    /* Styles Dashboard Admin */
    #dashboard table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
    #dashboard th, #dashboard td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #dashboard th { background-color: #f2f2f2; }
    .filter-btn { margin: 5px; cursor: pointer; padding: 5px 10px; }
    .active-filter { background-color: #4CAF50; color: white; border: none; }

    /* --- NOUVEAU : Styles de la Modale (Fen√™tre de formulaire) --- */
    .modal-overlay {
        display: none; /* Cach√© par d√©faut */
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal-content input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .btn-confirm { background-color: #0099ff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 10px;}
    .btn-cancel { background-color: #aaa; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; margin-top: 10px; width: 100%; }
</style>
</head>
<body>

<div class="background-logo"></div>

<h1 class="title">Commande de kits de survie</h1>

<div id="admin-tab" style="text-align:center; margin-bottom:10px;">
  <button id="show-login-btn" class="button-lydia">Espace Admin</button>
</div>

<div id="admin-login-form" style="display:none; margin-top:20px; text-align:center;">
  <input type="email" id="admin-email" placeholder="Email admin"><br><br>
  <input type="password" id="admin-password" placeholder="Mot de passe"><br><br>
  <button type="button" id="admin-login-btn" class="button-lydia">Se connecter</button>
  <p id="admin-login-error" style="color:red;"></p>
</div>

<div class="courses-container" id="courses"></div>

<div id="order-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title">Vos informations</h2>
        <p id="modal-desc" style="font-size:0.9em; color:#666; margin-bottom:15px;"></p>
        
        <input type="text" id="input-nom" placeholder="Votre Nom (ex: Dupont)">
        <input type="text" id="input-prenom" placeholder="Votre Pr√©nom (ex: Marie)">
        <input type="email" id="input-email" placeholder="Votre Email (pour confirmation)">
        
        <button id="confirm-order-btn" class="btn-confirm">Valider et Payer via Lydia</button>
        <button onclick="closeModal()" class="btn-cancel">Annuler</button>
    </div>
</div>

<div id="dashboard" style="display:none; margin-top:20px; padding: 20px; background: #fff;">
  <h2>Gestion des commandes</h2>
  
  <div style="margin-bottom: 15px;">
    <button onclick="loadOrders('pay√©')" class="filter-btn active-filter" id="btn-paid">Commandes PAY√âES</button>
    <button onclick="loadOrders('all')" class="filter-btn" id="btn-all">Toutes les commandes</button>
    <button onclick="auth.signOut()" class="filter-btn" style="float:right; background:red; color:white;">D√©connexion</button>
  </div>

  <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Email</th>
            <th>Kit / Cours</th>
            <th>Type</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="orders-table"></tbody>
      </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // üîπ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD6G1fbaPTLr7t2gABLA5MoeG1HP3QCuKg",
    authDomain: "projet-pedago-adcn.firebaseapp.com",
    projectId: "projet-pedago-adcn",
    storageBucket: "projet-pedago-adcn.appspot.com",
    messagingSenderId: "124299875258",
    appId: "1:124299875258:web:981376bd8c6cf4ce4c4383"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // üîπ Lien Lydia
  const LYDIA_LINK = "https://pots.lydia.me/collect/commandes-tableaux-recap-9985755/fr";

  // üîπ Liste des cours
  const courses = [
    {
      name: "UE1 Biopathologies tissulaires, illustrations et moyens d‚Äôexploration", 
      description: "Cours imprim√©", 
      priceNormal: "8,40‚Ç¨", 
      priceArrondi: "9‚Ç¨"
    },
    {
      name: "UE2 Bases mol√©culaires, cellulaires et tissulaires des traitements m√©dicamenteux", 
      description: "Cours imprim√©", 
      priceNormal: "8,40‚Ç¨", 
      priceArrondi: "9‚Ç¨"
    }
  ];

  // Variables temporaires pour la commande en cours
  let currentSelectedCourse = null;
  let currentSelectedType = null;

  // üîπ Charger les cours (Vue Client)
  function loadCourses() {
    const container = document.getElementById("courses");
    container.innerHTML = "";
    courses.forEach(c => {
      const div = document.createElement("div");
      div.classList.add("course-card");
      div.innerHTML = `
        <h3>${c.name}</h3>
        <p>${c.description}</p>
        <button class="button-lydia normal">Prix normal (${c.priceNormal})</button>
        <button class="button-lydia arrondi">Prix arrondi / don (${c.priceArrondi})</button>
      `;
      container.appendChild(div);

      div.querySelector(".normal").addEventListener("click", () => openModal(c, "normal"));
      div.querySelector(".arrondi").addEventListener("click", () => openModal(c, "arrondi"));
    });
  }

  // üîπ Gestion de la Modale (Ouverture/Fermeture)
  const modal = document.getElementById("order-modal");
  const inputNom = document.getElementById("input-nom");
  const inputPrenom = document.getElementById("input-prenom");
  const inputEmail = document.getElementById("input-email");

  function openModal(course, type) {
      currentSelectedCourse = course;
      currentSelectedType = type;
      
      // Mettre √† jour le texte de la modale
      document.getElementById("modal-title").innerText = "Finaliser la commande";
      const prix = type === "normal" ? course.priceNormal : course.priceArrondi;
      document.getElementById("modal-desc").innerText = `Vous avez choisi : ${course.name} (${prix})`;
      
      modal.style.display = "flex";
  }

  function closeModal() {
      modal.style.display = "none";
      // Reset des champs
      inputNom.value = "";
      inputPrenom.value = "";
      inputEmail.value = "";
  }

  // üîπ Validation de la commande et Redirection Lydia
  document.getElementById("confirm-order-btn").addEventListener("click", async () => {
      const nom = inputNom.value.trim();
      const prenom = inputPrenom.value.trim();
      const email = inputEmail.value.trim();

      if(!nom || !prenom || !email) {
          alert("Merci de remplir tous les champs (Nom, Pr√©nom et Email).");
          return;
      }

      // D√©sactiver le bouton pour √©viter double clic
      const btn = document.getElementById("confirm-order-btn");
      btn.innerText = "Enregistrement...";
      btn.disabled = true;

      try {
        // 1. Enregistrer dans Firebase
        await db.collection("orders").add({
          cours: currentSelectedCourse.name,
          type: currentSelectedType,
          nom: nom,
          prenom: prenom,
          email: email,
          statut: "en attente", // Reste en attente jusqu'√† validation manuelle admin
          date: new Date().toISOString()
        });

        // 2. Rediriger vers Lydia
        alert("Commande enregistr√©e ! Vous allez √™tre redirig√© vers Lydia pour le paiement.");
        window.location.href = LYDIA_LINK; 

      } catch(e) {
        console.error(e);
        alert("Erreur lors de l'enregistrement : " + e.message);
        btn.innerText = "Valider et Payer via Lydia";
        btn.disabled = false;
      }
  });

  loadCourses();

  // ==============================================
  // üîπ GESTION INTERFACE ADMIN
  // ==============================================
  
  const loginForm = document.getElementById("admin-login-form");
  const dashboard = document.getElementById("dashboard");

  document.getElementById("show-login-btn").addEventListener("click", () => {
    if(dashboard.style.display === "block") return; 
    loginForm.style.display = (loginForm.style.display === "none") ? "block" : "none";
  });

  // Connexion
  document.getElementById("admin-login-btn").addEventListener("click", (e) => {
    e.preventDefault();
    const email = document.getElementById("admin-email").value.trim();
    const password = document.getElementById("admin-password").value;

    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        document.getElementById("admin-login-error").innerText = "Erreur de connexion.";
        console.error(err);
      });
  });

  // Surveillance Auth
  auth.onAuthStateChanged(user => {
    if(user){
      loginForm.style.display = "none";
      document.getElementById("courses").style.display = "none"; 
      dashboard.style.display = "block";
      document.getElementById("show-login-btn").innerText = "Admin : " + user.email;
      loadOrders('pay√©'); // Chargement par d√©faut
    } else {
      dashboard.style.display = "none";
      document.getElementById("courses").style.display = "block"; 
      document.getElementById("show-login-btn").innerText = "Connexion Admin";
    }
  });

  // Charger les commandes Admin
  async function loadOrders(filterMode = 'pay√©') {
    const table = document.getElementById("orders-table");
    table.innerHTML = "<tr><td colspan='8'>Chargement...</td></tr>";
    
    document.getElementById('btn-paid').className = filterMode === 'pay√©' ? 'filter-btn active-filter' : 'filter-btn';
    document.getElementById('btn-all').className = filterMode === 'all' ? 'filter-btn active-filter' : 'filter-btn';

    try {
      let query = db.collection("orders");

      if (filterMode === 'pay√©') {
        query = query.where("statut", "==", "pay√©");
      } else {
        query = query.orderBy("date", "desc");
      }

      const snapshot = await query.get();
      
      table.innerHTML = ""; 
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='8'>Aucune commande trouv√©e.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const o = doc.data();
        const tr = document.createElement("tr");
        
        const color = o.statut === "pay√©" ? "green" : "orange";
        // Gestion cas o√π nom/prenom anciens sont manquants
        const nomAffichage = o.nom ? o.nom.toUpperCase() : "-";
        const prenomAffichage = o.prenom ? o.prenom : "-";

        tr.innerHTML = `
          <td>${new Date(o.date).toLocaleDateString()} ${new Date(o.date).toLocaleTimeString()}</td>
          <td><strong>${nomAffichage}</strong></td>
          <td>${prenomAffichage}</td>
          <td>${o.email}</td>
          <td>${o.cours}</td>
          <td>${o.type}</td>
          <td style="color:${color}; font-weight:bold;">${o.statut}</td>
          <td>
            ${o.statut !== "pay√©" ? `<button onclick="validatePayment('${doc.id}')" style="cursor:pointer; background:#4CAF50; color:white; border:none; padding:5px;">Valider Paiement</button>` : '‚úÖ'}
          </td>
        `;
        table.appendChild(tr);
      });

    } catch(e) {
      console.error("Erreur : ", e);
      if(e.message.includes("index")) {
        alert("Erreur : Index Firestore manquant. V√©rifiez la console.");
      } else {
        alert("Erreur chargement : " + e.message);
      }
    }
  }

  // Valider une commande
  window.validatePayment = async function(docId) {
    // L'admin doit v√©rifier sur son t√©l√©phone que Lydia a bien re√ßu l'argent avant de cliquer ici
    if(confirm("Avez-vous bien re√ßu le paiement Lydia correspondant √† cette commande ?")) {
      try {
        await db.collection("orders").doc(docId).update({ statut: "pay√©" });
        const isAllView = document.getElementById('btn-all').classList.contains('active-filter');
        loadOrders(isAllView ? 'all' : 'pay√©');
      } catch(e) {
        alert("Erreur : " + e.message);
      }
    }
  }
</script>

</body>
</html>
