<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commande de kits de survie</title>
<link rel="stylesheet" href="style.css">
<style>
    /* --- AJOUTS CSS --- */
    
    /* Styles des cartes de cours */
    .course-card h3 {
        white-space: normal;
        overflow: visible;
        word-wrap: break-word;
        min-height: 60px;
        margin-bottom: 15px;
        font-size: 1.1em;
        line-height: 1.4;
    }

    /* Organisation des boutons de prix */
    .price-section {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    .price-label {
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 5px;
        display: block;
        color: #333;
    }
    
    /* Couleurs sp√©cifiques des boutons */
    .btn-bw { background-color: #555 !important; color: white; } /* Gris pour N&B */
    .btn-col { background-color: #6C63FF !important; color: white; } /* Violet/Bleu pour Couleur */

    /* Styles Dashboard Admin */
    #dashboard table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
    #dashboard th, #dashboard td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #dashboard th { background-color: #f2f2f2; }
    
    /* Boutons de filtres du dashboard */
    .filter-btn { margin: 5px; cursor: pointer; padding: 8px 15px; border-radius: 4px; border: 1px solid #ccc; background: #eee;}
    .active-filter { background-color: #0099ff; color: white; border-color: #007acc; }
    .btn-archive { background-color: #666; color: white; }

    /* --- Styles de la Modale (Fen√™tre de formulaire) --- */
    .modal-overlay {
        display: none; /* Cach√© par d√©faut */
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal-content input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .btn-confirm { background-color: #0099ff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; width: 100%; font-size: 16px; margin-top: 10px;}
    .btn-cancel { background-color: #aaa; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; margin-top: 10px; width: 100%; }
</style>
</head>
<body>

<div class="background-logo"></div>

<h1 class="title">Commande de kits de survie</h1>

<div id="admin-tab" style="text-align:center; margin-bottom:10px;">
  <button id="show-login-btn" class="button-lydia">Espace Admin</button>
</div>

<div id="admin-login-form" style="display:none; margin-top:20px; text-align:center;">
  <input type="email" id="admin-email" placeholder="Email admin"><br><br>
  <input type="password" id="admin-password" placeholder="Mot de passe"><br><br>
  <button type="button" id="admin-login-btn" class="button-lydia">Se connecter</button>
  <p id="admin-login-error" style="color:red;"></p>
</div>

<div class="courses-container" id="courses"></div>

<div id="order-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title">Vos informations</h2>
        <p id="modal-desc" style="font-size:0.9em; color:#666; margin-bottom:15px;"></p>
        
        <input type="text" id="input-nom" placeholder="Votre Nom (ex: Dupont)">
        <input type="text" id="input-prenom" placeholder="Votre Pr√©nom (ex: Marie)">
        <input type="email" id="input-email" placeholder="Votre Email (pour confirmation)">
        
        <button id="confirm-order-btn" class="btn-confirm">Valider et Payer via Lydia</button>
        <button onclick="closeModal()" class="btn-cancel">Annuler</button>
    </div>
</div>

<div id="dashboard" style="display:none; margin-top:20px; padding: 20px; background: #fff;">
  <h2>Gestion des commandes</h2>
  
  <div style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
    <button onclick="loadOrders('pending')" class="filter-btn active-filter" id="btn-pending">üìã √Ä TRAITER (En attente)</button>
    <button onclick="loadOrders('archive')" class="filter-btn btn-archive" id="btn-archive">üóÑÔ∏è ARCHIVES (Pay√©es)</button>
    <button onclick="loadOrders('all')" class="filter-btn" id="btn-all">Voir Tout</button>
    
    <button onclick="auth.signOut()" class="filter-btn" style="float:right; background:red; color:white; border:none;">D√©connexion</button>
  </div>

  <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Email</th>
            <th>Kit / Cours</th>
            <th>Type</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="orders-table"></tbody>
      </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
  // üîπ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD6G1fbaPTLr7t2gABLA5MoeG1HP3QCuKg",
    authDomain: "projet-pedago-adcn.firebaseapp.com",
    projectId: "projet-pedago-adcn",
    storageBucket: "projet-pedago-adcn.appspot.com",
    messagingSenderId: "124299875258",
    appId: "1:124299875258:web:981376bd8c6cf4ce4c4383"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // üîπ Lien Lydia
  const LYDIA_LINK = "https://pots.lydia.me/collect/commandes-tableaux-recap-9985755/fr";

  // üîπ Liste des cours
  const courses = [
    {
      name: "UE1 Biopathologies tissulaires, illustrations et moyens d‚Äôexploration", 
      description: "Kit de Survie", 
      priceBW: "4,45‚Ç¨",      
      priceBWR: "5‚Ç¨",        
      priceCol: "9,90‚Ç¨",    
      priceColR: "10‚Ç¨"       
    },
    {
      name: "UE2 Bases mol√©culaires, cellulaires et tissulaires des traitements m√©dicamenteux", 
      description: "Kit de Survie", 
      priceBW: "3,75‚Ç¨",
      priceBWR: "4‚Ç¨",
      priceCol: "7,80‚Ç¨",
      priceColR: "8‚Ç¨"
    },
    {
      name: "UE3 Tissus sanguins et syst√®me immunitaire", 
      description: "Kit de Survie", 
      priceBW: "3,05‚Ç¨",
      priceBWR: "3,50‚Ç¨",
      priceCol: "5,70‚Ç¨",
      priceColR: "6‚Ç¨"
    }
  ];

  // Variables temporaires
  let currentSelectedCourse = null;
  let currentSelectedType = null;
  let currentSelectedPrice = null;

  // üîπ Charger les cours (Vue Client)
  function loadCourses() {
    const container = document.getElementById("courses");
    container.innerHTML = "";
    courses.forEach(c => {
      const div = document.createElement("div");
      div.classList.add("course-card");
      
      div.innerHTML = `
        <h3>${c.name}</h3>
        <p>${c.description}</p>
        
        <div class="price-section">
            <span class="price-label">üñ®Ô∏è Noir & Blanc</span>
            <button class="button-lydia btn-bw" onclick="initModal('${c.name}', 'nb_exact', '${c.priceBW}')">
                Exact (${c.priceBW})
            </button>
            <button class="button-lydia btn-bw" onclick="initModal('${c.name}', 'nb_arrondi', '${c.priceBWR}')">
                Arrondi (${c.priceBWR})
            </button>
        </div>

        <div class="price-section">
            <span class="price-label">üåà Couleur</span>
            <button class="button-lydia btn-col" onclick="initModal('${c.name}', 'col_exact', '${c.priceCol}')">
                Exact (${c.priceCol})
            </button>
            <button class="button-lydia btn-col" onclick="initModal('${c.name}', 'col_arrondi', '${c.priceColR}')">
                Arrondi (${c.priceColR})
            </button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // üîπ Gestion de la Modale
  const modal = document.getElementById("order-modal");
  const inputNom = document.getElementById("input-nom");
  const inputPrenom = document.getElementById("input-prenom");
  const inputEmail = document.getElementById("input-email");

  function initModal(courseName, typeKey, priceValue) {
      currentSelectedCourse = courses.find(c => c.name === courseName);
      let typeLabel = "";
      if(typeKey === 'nb_exact') typeLabel = "Noir & Blanc (Exact)";
      if(typeKey === 'nb_arrondi') typeLabel = "Noir & Blanc (Arrondi)";
      if(typeKey === 'col_exact') typeLabel = "Couleur (Exact)";
      if(typeKey === 'col_arrondi') typeLabel = "Couleur (Arrondi)";

      currentSelectedType = typeLabel;
      currentSelectedPrice = priceValue;
      
      document.getElementById("modal-title").innerText = "Finaliser la commande";
      document.getElementById("modal-desc").innerText = `Choix : ${courseName}\nType : ${typeLabel}\nPrix : ${priceValue}`;
      modal.style.display = "flex";
  }

  function closeModal() {
      modal.style.display = "none";
      inputNom.value = ""; inputPrenom.value = ""; inputEmail.value = "";
  }

  // üîπ Validation Commande
  document.getElementById("confirm-order-btn").addEventListener("click", async () => {
      const nom = inputNom.value.trim();
      const prenom = inputPrenom.value.trim();
      const email = inputEmail.value.trim();

      if(!nom || !prenom || !email) {
          alert("Merci de remplir tous les champs.");
          return;
      }

      const btn = document.getElementById("confirm-order-btn");
      btn.innerText = "Enregistrement...";
      btn.disabled = true;

      try {
        await db.collection("orders").add({
          cours: currentSelectedCourse.name,
          type: currentSelectedType,
          prix: currentSelectedPrice,
          nom: nom,
          prenom: prenom,
          email: email,
          statut: "en attente", 
          date: new Date().toISOString()
        });
        alert("Commande enregistr√©e ! Vous allez √™tre redirig√© vers Lydia.");
        window.location.href = LYDIA_LINK; 
      } catch(e) {
        console.error(e);
        alert("Erreur : " + e.message);
        btn.innerText = "Valider et Payer via Lydia";
        btn.disabled = false;
      }
  });

  loadCourses();

  // ==============================================
  // üîπ GESTION INTERFACE ADMIN
  // ==============================================
  
  const loginForm = document.getElementById("admin-login-form");
  const dashboard = document.getElementById("dashboard");

  document.getElementById("show-login-btn").addEventListener("click", () => {
    if(dashboard.style.display === "block") return; 
    loginForm.style.display = (loginForm.style.display === "none") ? "block" : "none";
  });

  document.getElementById("admin-login-btn").addEventListener("click", (e) => {
    e.preventDefault();
    const email = document.getElementById("admin-email").value.trim();
    const password = document.getElementById("admin-password").value;
    auth.signInWithEmailAndPassword(email, password).catch(err => {
        document.getElementById("admin-login-error").innerText = "Erreur de connexion.";
    });
  });

  auth.onAuthStateChanged(user => {
    if(user){
      loginForm.style.display = "none";
      document.getElementById("courses").style.display = "none"; 
      dashboard.style.display = "block";
      document.getElementById("show-login-btn").innerText = "Admin : " + user.email;
      loadOrders('pending'); // CHARGEMENT PAR D√âFAUT : Commandes √† traiter
    } else {
      dashboard.style.display = "none";
      document.getElementById("courses").style.display = "block"; 
      document.getElementById("show-login-btn").innerText = "Connexion Admin";
    }
  });

  // üîπ Charger les commandes (Logique "Archives" vs "√Ä traiter")
  async function loadOrders(filterMode = 'pending') {
    const table = document.getElementById("orders-table");
    table.innerHTML = "<tr><td colspan='8' style='text-align:center;'>Chargement...</td></tr>";
    
    // Gestion des classes des boutons (visuel)
    document.getElementById('btn-pending').className = 'filter-btn' + (filterMode === 'pending' ? ' active-filter' : '');
    document.getElementById('btn-archive').className = 'filter-btn btn-archive' + (filterMode === 'archive' ? ' active-filter' : '');
    document.getElementById('btn-all').className = 'filter-btn' + (filterMode === 'all' ? ' active-filter' : '');

    try {
      let query = db.collection("orders");

      if (filterMode === 'pending') {
        // Mode "√Ä Traiter" : Seulement les non pay√©es
        query = query.where("statut", "==", "en attente");
      } else if (filterMode === 'archive') {
        // Mode "Archive" : Seulement les pay√©es
        query = query.where("statut", "==", "pay√©");
      } else {
        // Mode "Tout" : Tri√© par date
        query = query.orderBy("date", "desc");
      }

      const snapshot = await query.get();
      
      table.innerHTML = ""; 
      if (snapshot.empty) {
        table.innerHTML = "<tr><td colspan='8' style='text-align:center; padding:20px;'>Aucune commande dans cette section.</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const o = doc.data();
        const tr = document.createElement("tr");
        
        const color = o.statut === "pay√©" ? "green" : "#e60000";
        const nomAffichage = o.nom ? o.nom.toUpperCase() : "-";
        const prenomAffichage = o.prenom ? o.prenom : "-";
        const prixAffichage = o.prix ? `(${o.prix})` : ""; 

        // Si la commande est archiv√©e (pay√©e), on n'affiche plus le bouton de validation
        let actionButton = '';
        if(o.statut === "pay√©") {
            actionButton = '‚úÖ Archiv√©';
        } else {
            actionButton = `<button onclick="validatePayment('${doc.id}')" style="cursor:pointer; background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:4px;">Valider Paiement</button>`;
        }

        tr.innerHTML = `
          <td>${new Date(o.date).toLocaleDateString()} <small>${new Date(o.date).toLocaleTimeString()}</small></td>
          <td><strong>${nomAffichage}</strong></td>
          <td>${prenomAffichage}</td>
          <td>${o.email}</td>
          <td>${o.cours}</td>
          <td>${o.type} ${prixAffichage}</td>
          <td style="color:${color}; font-weight:bold;">${o.statut.toUpperCase()}</td>
          <td style="text-align:center;">${actionButton}</td>
        `;
        table.appendChild(tr);
      });

    } catch(e) {
      console.error("Erreur : ", e);
      if(e.message.includes("index")) {
        alert("ATTENTION ADMIN : Un index Firestore est manquant pour trier par date. Regardez la console du navigateur.");
      } else {
        alert("Erreur chargement : " + e.message);
      }
    }
  }

  // Valider une commande (la fait passer dans les archives)
  window.validatePayment = async function(docId) {
    if(confirm("Avez-vous re√ßu l'argent ? Cette action d√©placera la commande dans les Archives.")) {
      try {
        await db.collection("orders").doc(docId).update({ statut: "pay√©" });
        // Recharge la vue actuelle (donc la commande va dispara√Ætre de "√Ä traiter")
        loadOrders('pending'); 
      } catch(e) {
        alert("Erreur : " + e.message);
      }
    }
  }
</script>

</body>
</html>
